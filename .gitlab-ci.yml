
image: maven:3.9.9-eclipse-temurin-17

stages:
  - install
  - build
  - test
  - sonarqube-check
  - debug
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  APP_NAME: mechyam-backend
  DEPLOY_PATH: /opt/mechyam
  FRONTEND_PATH: /opt/mechyam/mechyam-frontend
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task

cache:
  key: maven-cache
  paths:
    - .m2/repository

before_script:
  - java -version
  - mvn -version

# ------------------------
# INSTALL STAGE
# ------------------------
install-dependencies:
  stage: install
  script:
    - mvn clean install -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# ------------------------
# BUILD STAGE
# ------------------------
build-backend:
  stage: build
  script:
    - mvn package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# ------------------------
# TEST STAGE
# ------------------------
test-backend:
  stage: test
  script:
    - mvn test
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# ------------------------
# SONARQUBE STAGE (Integrated Version)
# ------------------------

sonarqube-check:
  stage: sonarqube-check
  image: maven:3.9.9-eclipse-temurin-17 # Use the same image as your build
  cache:
    key: maven-cache # Use the same cache key as your other jobs
    paths:
      - .m2/repository
      - .sonar/cache
  script:
    # We use the Maven plugin because your project is Maven-based
    - mvn verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=nebulytixtechnologies-web_Mechyam_BD_prod -Dsonar.qualitygate.wait=false
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# ------------------------
# DEBUG STAGE
# ------------------------
debug-env:
  stage: debug
  script:
    - echo "======= CI VARIABLES ======="
    - printenv | sort
    - echo "======= CI DEBUG INFO ======="
    - echo "CI_PROJECT_PATH=$CI_PROJECT_PATH"
    - echo "CI_COMMIT_BRANCH=$CI_COMMIT_BRANCH"
    - echo "CI_PIPELINE_ID=$CI_PIPELINE_ID"
    - echo "SERVER_IP=$SERVER_IP"
    - echo "SSH_USER=$SSH_USER"
    - echo "============================="
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'


# ------------------------
# DEPLOY STAGE (BACKEND + FRONTEND)
# ------------------------
deploy-all:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh docker-cli docker-compose git
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts

  script:
    - scp target/*.jar $SSH_USER@$SERVER_IP:$DEPLOY_PATH/$APP_NAME.jar

    - |
      ssh $SSH_USER@$SERVER_IP << 'EOF'
      set -e

      echo "▶ Moving to /opt/mechyam"
      cd /opt/mechyam

      echo "▶ Building backend image"
      docker build -t mechyam-backend .

      echo "▶ Updating frontend"
      cd /opt/mechyam/mechyam_FD_prod
      git pull 

      echo "▶ Building frontend image"
      cd /opt/mechyam/mechyam_FD_prod/mechyam-frontend
      docker build -t mechyam-frontend-new .

      echo "▶ Restarting containers"
      cd /opt/mechyam
      docker compose down
      docker compose up -d --build

      echo "✅ Deployment finished successfully"
      EOF

  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
