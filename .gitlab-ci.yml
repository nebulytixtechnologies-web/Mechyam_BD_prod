image: maven:3.9.9-eclipse-temurin-17

stages:
  - install
  - build
  - test
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  APP_NAME: mechyam-backend
  DEPLOY_PATH: /opt/mechyam

cache:
  key: maven-cache
  paths:
    - .m2/repository

before_script:
  - java -version
  - mvn -version

# ------------------------
# INSTALL STAGE
# ------------------------
install-dependencies:
  stage: install
  script:
    - mvn clean install -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# ------------------------
# BUILD STAGE
# ------------------------
build-backend:
  stage: build
  script:
    - mvn package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# ------------------------
# TEST STAGE
# ------------------------
test-backend:
  stage: test
  script:
    - mvn test
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# ------------------------
# DEPLOY STAGE (SSH)
# ------------------------
deploy-backend:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh
  script:
    - echo "Deploying backend..."
    - scp target/*.jar $SSH_USER@$SERVER_IP:$DEPLOY_PATH/$APP_NAME.jar
    - ssh $SSH_USER@$SERVER_IP "pkill -f '$APP_NAME.jar' || true"
    - ssh $SSH_USER@$SERVER_IP "nohup java -jar $DEPLOY_PATH/$APP_NAME.jar > app.log 2>&1 &"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
