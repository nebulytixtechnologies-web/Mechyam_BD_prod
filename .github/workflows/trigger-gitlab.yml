name: Trigger GitLab CI

on:
  push:
    branches:
      - main

jobs:
  sync-and-trigger:
    runs-on: ubuntu-latest
    steps:
    # STEP 1: Get the new code from GitHub
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to sync all history

    # STEP 2: Force the new code into GitLab
      - name: Push Code to GitLab
        run: |
          # Push the current branch to GitLab using a Personal Access Token (PAT)
          # git push --force https://${{ secrets.GITLAB_USER }}:${{ secrets.GITLAB_PAT }}@gitlab.com HEAD:main
          git push https://nebulytixtechnologies-web:${{ secrets.GITLAB_PAT }}@gitlab.com/nebulytixtechnologies-web/Mechyam_BD_prod.git HEAD:main


    # STEP 3: Trigger the Pipeline (Corrected URL)
      - name: Trigger GitLab via cURL
        env:
          # Mapping secrets to environment variables fixes the brace error
          PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID }}
          TOKEN: ${{ secrets.GITLAB_TRIGGER_TOKEN }}
        run: |
          curl --request POST \
            --form token="$TOKEN" \
            --form ref="main" \
            "https://gitlab.com/api/v4/projects/$PROJECT_ID/trigger/pipeline"
        

